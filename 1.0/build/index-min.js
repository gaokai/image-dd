/*! image-dd - v1.0 - 2013-06-09 2:26:39 PM
* Copyright (c) 2013 yumen.gk; Licensed  */
KISSY.add("gallery/image-dd/1.0/asdbase",function(){function a(){}return a.prototype={ATTR:function(a,b){if(void 0===a||null===a)return void 0;var c=this.ATTRS||{};return void 0===c[a]?void 0===b?void 0:c[a]=b:void 0===b?c[a]:c[a]=b},DATA:function(a,b){if(void 0===a||null===a)return void 0;var c=this.DATAS||{};return void 0===c[a]?void 0===b?void 0:c[a]=b:void 0===b?c[a]:c[a]=b},STATU:function(a,b){if(void 0===a||null===a)return void 0;var c=this.STATUS||{};return void 0===c[a]?void 0===b?void 0:c[a]=b:void 0===b?c[a]:c[a]=b}},a}),KISSY.add("gallery/image-dd/1.0/index",function(a,b,c,d){function e(b){var c=this;c.config=a.clone(q),c.ATTRS=a.clone(n),c.STATUS=a.clone(o),c.DATAS=a.clone(p),a.mix(c.config,{ele:b?a.isArray(b)?b:[b]:[]}),c._init()}function f(a){if(a.halt(),s<n.DEGRADATION)return++s,!1;s=0;var b=this,c=i(a),d={left:c.x-b.ATTR("mousedownCoo").x,top:c.y-b.ATTR("mousedownCoo").y},e=parseInt(b.ATTR("activeImgPos").top,10)+d.top,f=parseInt(b.ATTR("activeImgPos").left,10)+d.left;b.ATTR("dragInfoX").push(f),b.ATTR("dragInfoY").push(e),b.ATTR("dragInfoTime").push((new Date).getTime()),l.css(b.ATTR("activeImg"),"top",e+"px"),l.css(b.ATTR("activeImg"),"left",f+"px")}function g(a){if(a.halt(),t<n.WHEEL_STEP)return++t,!1;t=0;var b=this;b.cleanRecords();var c="";if(a.deltaY&&(c=a.deltaY>0?"zoom":"shrunk"),""==c)return!1;if(c!=u)return u=c,!1;var e={width:j(b.ATTR("activeImg"),"width"),height:j(b.ATTR("activeImg"),"height")};if("shrunk"==c&&e.width<b.ATTR("defaultMinWidth")||"zoom"==c&&e.width>b.ATTR("defaultMaxWidth"))return!1;var f=i(a),g={x:parseInt(b.ATTR("activeImg").style.left,10),y:parseInt(b.ATTR("activeImg").style.top,10)},h={left:j(b.ATTR("activeImg"),"left"),top:j(b.ATTR("activeImg"),"top")},k=h.left,l=h.top,m=e.width,o=3*n.WHEEL_PIX*(e.width/b.ATTR("initWidth")),p=o*(e.height/e.width);if(f.x>=g.x&&f.x<=g.x+e.width&&f.y>=g.y&&f.y<=g.y+e.height){var q=1,r=1,s=1;r=(f.x-g.x)/e.width,s=(f.y-g.y)/e.height,"shrunk"==c?(k+=o*r,l+=p*s):(k-=o*r,l-=p*s)}else{var q=.5;"shrunk"==c?(k+=o*q,l+=p*q):(k-=o*q,l-=p*q)}"shrunk"==c?m-=o:m+=o,b.ATTR("anim")&&b.ATTR("anim").isRunning&&b.ATTR("anim").stop(!1),b.ATTR("anim",new d(b.ATTR("activeImg"),{left:parseInt(1e3*k,10)/1e3+"px",top:parseInt(1e3*l,10)/1e3+"px",width:parseInt(m,10)+"px"},.1).run())}function h(a){var b=this,c=i(a),d={left:c.x-b.ATTR("mousedownCoo").x,top:c.y-b.ATTR("mousedownCoo").y},e=parseInt(b.ATTR("activeImgPos").top,10)+d.top,f=parseInt(b.ATTR("activeImgPos").left,10)+d.left;b.ATTR("dragInfoX").push(f),b.ATTR("dragInfoY").push(e),b.ATTR("dragInfoTime").push((new Date).getTime()),b.cancelEvent(),b.afterUserDrag_MyShowTime()}function i(a){return{x:a.pageX||a.clientX+(document.documentElement.scrollLeft||document.body.scrollLeft),y:a.pageY||a.clientY+(document.documentElement.scrollTop||document.body.scrollTop)}}function j(b,c){var d="";return a.UA&&a.UA.ie&&"IMG"==b.tagName&&"height"==c?b.offsetHeight:(window.getComputedStyle?d=window.getComputedStyle(b,null)[c]:(c=k(c),d=b.currentStyle[c]),d=d.replace(/[^0-9+-\.]/g,""),parseInt(d,10)?0-(0-d):0)}function k(a){return a.replace(/-([a-z])/gi,function(a,b){return b.toUpperCase()})}var l=a.DOM,m=a.Event;a.all;var n={WHEEL_STEP:1,WHEEL_PIX:50,SHOW_DOWN:0,MOUSE_MOVE_AUTO_CLOSE_TIMER:5e3,DEGRADATION:2,activeImg:null,activeImgPos:{left:0,top:0},mousedownCoo:{},anim:null,initAnim:null,bigImgObj:new Image,initWidth:0,defaultMaxWidth:1e4,defaultMinWidth:50,ieIframeMask:null,dragInfoX:[],dragInfoY:[],dragInfoTime:[],autoSlideAnim:null,popupMask:null,popupBd:null,popupOpacityBg:null,popupBox:null,popupHd:null},o={inited:!1},p={POPUP_HD_TPL:'<div class="box-hd close-rt-wrap" ><a href="#" title="\u6309\u9000\u51fa\u952e\uff0c\u4e5f\u53ef\u4ee5\u5173\u95ed\u54e6" class="close-rt J_Close" id="J_CloseImageDD"></a></div>',POPUP_IMG:'<img title="\u9f20\u6807\u6eda\u8f6e\u53ef\u4ee5\u653e\u5927\u56fe\u7247" class="G_K" style="width:{{showWidth}}px;left:{{left}}px;top:{{top}}px;" src="{{imgSrc}}"  />',POPUP_TPL:'<div class="img-dd-mask">                    <div class="img-dd-opacity-bg"></div>                 </div>',POPUP_BOX_TPL:'<div class="img-dd-box"></div>',POPUP_IFRAME_TPL:'<iframe class="ie-popup-mask hidden"></iframe>'},q={ele:[]},r={_init:function(){var b=this,c=b.config;a.each(c.ele,function(a){b._bindEvent(a)})},add:function(b,c){var d=this,e=d.config;a.isArray(b)?(e.ele=e.ele.concate(b),a.each(b,function(a){d._bindEvent(a,c)})):(e.ele.push(b),d._bindEvent(b,c))},_bindEvent:function(a,b){var c=this;return c.config,null==a?!1:(m.on(a,"click",function(a){var d=a.target;"IMG"==d.tagName.toUpperCase()&&(!b||l.hasClass(d,b))&&"G_K"!=d.className&&(a.halt(),1!=c.STATU("inited")&&(c._createPopup(),c._initHTMLElement(),c._bindPopupMousedown(),c.STATU("inited",!0)),c._showPopupImg(d.getAttribute("data-original-url"),d.getAttribute("src")),l.show(c.ATTR("popupMask")),l.show(c.ATTR("popupBd")),l.show(c.ATTR("ieIframeMask")),l.show(c.ATTR("closeBtn")))}),void 0)},_showPopupImg:function(b,e){var f=this,g=document.body.clientWidth||doucment.doucmentElement.clientWidth;f.ATTR("popupBd").innerHTML=c(f.DATA("POPUP_IMG")).render({imgSrc:e,imgAlt:"\u56fe\u7247\u5927\u56fe",showWidth:parseInt(g/2,10),left:parseInt(g/4,10),top:0}),a.UA.ie&&6==a.UA.ie&&(f.ATTR("popupMask").style.height=(document.body.scrollHeight||document.documentElement.scrollHeight)+"px",f.ATTR("popupMask").style.width=(document.body.scrollWidth||document.documentElement.scrollWidth)+"px"),f.ATTR("initWidth",parseInt(g/2,10)),f.cleanRecords(!0),f.ATTR("activeImg",l.get("IMG",f.ATTR("popupBd"))),f.ATTR("initAnim")&&f.ATTR("initAnim").stop(!1),f.ATTR("initAnim",new d(f.ATTR("activeImg"),{top:(document.body.scrollTop||document.documentElement.scrollTop)+30+"px"},1,"easeOutStrong").run()),f.ATTR("bigImgObj").onload=null,(b||""!=b)&&(f.ATTR("bigImgObj",null),f.ATTR("bigImgObj",new Image),f.ATTR("bigImgObj").onload=function(){f.ATTR("activeImg").src=b}),f.ATTR("bigImgObj").src=b,f.registerWheelEvent()},registerWheelEvent:function(){m.on(document,"DOMMouseScroll",g,this),m.on(document,"mousewheel",g,this),m.on(document,"keyup",this.closePopup,this)},cancelWheelEvent:function(){m.remove(document,"DOMMouseScroll",g,this),m.remove(document,"mousewheel",g,this),m.remove(document,"keyup",this.closePopup,this)},registerEvent:function(){var a=this;m.on(document,"mouseup",h,a),m.on(document,"mousemove",f,a)},cancelEvent:function(){var a=this;m.remove(document,"mouseup",h,a),m.remove(document,"mousemove",f,a)},_createPopup:function(){var b=this;b.config,b.ATTR("popupMask",l.create(b.DATA("POPUP_TPL"))),b.ATTR("popupBd",l.create(b.DATA("POPUP_BOX_TPL"))),b.ATTR("closeBtn",l.create(b.DATA("POPUP_HD_TPL"))),a.UA.ie&&6==a.UA.ie&&(b.ATTR("ieIframeMask",l.create(b.DATA("POPUP_IFRAME_TPL"))),b.ATTR("ieIframeMask").style.width=document.documentElement.scrollWidth+"px",b.ATTR("ieIframeMask").style.height=document.documentElement.scrollHeight+"px",document.body.appendChild(b.ATTR("ieIframeMask"))),document.body.appendChild(b.ATTR("popupMask")),document.body.appendChild(b.ATTR("popupBd")),b.ATTR("popupMask").appendChild(b.ATTR("closeBtn"))},_bindPopupMousedown:function(){var b=this;return b.config,m.on(b.ATTR("popupBd"),"mousedown",function(a){var c=a.target;"IMG"==c.tagName.toUpperCase()&&(a.halt(),b.ATTR("initAnim")&&b.ATTR("initAnim").stop(!1),b.ATTR("initAnim",null),b.cleanRecords(!0),b.ATTR("dragInfoX").push(j(c,"left")),b.ATTR("dragInfoY").push(j(c,"top")),b.ATTR("dragInfoTime").push((new Date).getTime()),b.ATTR("activeImg",c),b.ATTR("mousedownCoo",i(a)),b.ATTR("activeImgPos",{left:j(c,"left"),top:j(c,"top")}),b.registerEvent())}),m.on(b.ATTR("closeBtn"),"click",function(a){a.halt(),b.closePopup()}),m.on(b.ATTR("popupMask"),"click",function(c){a.UA.ie&&6==a.UA.ie&&l.hasClass(c.target,"img-dd-opacity-bg")&&(c.halt(),b.closePopup())}),!0},_initHTMLElement:function(){var a=this;a.ATTR("popupOpacityBg",l.get(".img-dd-opacity-bg",a.ATTR("popupMask"))),a.ATTR("popupBox",l.get(".img-dd-box",a.ATTR("popupMask"))),a.ATTR("popupHd",l.get(".box-hd",a.ATTR("popupMask")))},afterUserDrag_MyShowTime:function(){{var a=this;a.ATTR("dragInfoX").length}return a.slide_straightLine(),!1},slide_straightLine:function(){var a,b,c=this,e={a:1e5,vx:0,vy:0,new_left:0,new_top:0,is_left:!0,is_top:!0},f=c.ATTR("dragInfoX"),g=c.ATTR("dragInfoY"),h=f.length,i=c.ATTR("dragInfoTime"),j=1;for(f[h-1],g[h-1],t0=i[h-1];h>j&&t0-i[h-++j]<50;);2==j&&t0-i[h-j]>500||(h>=j?(t1=i[h-j+1],a=f[h-1]-f[h-j],b=g[h-1]-g[h-j],e.vx=1e3*(a/(t0-t1)),e.vy=1e3*(b/(t0-t1)),e.isLeft=a>0?!0:!1,e.isTop=b>0?!0:!1):(e.vx=100,e.vy=100,e.isLeft=f[h-1]>f[0]?!0:!1,e.isTop=g[h-1]>g[0]?!0:!1),e.duration=parseInt(Math.abs(1e3*(e.v/e.a)),10),e.absDisX=e.vx*e.vx/2/e.a,e.absDisY=e.vy*e.vy/2/e.a,e.addLeft=(e.isLeft?"+=":"-=")+e.absDisX,e.addTop=(e.isTop?"+=":"-=")+e.absDisY,c.ATTR("autoSlideAnim",new d(c.ATTR("activeImg"),{left:e.addLeft,top:e.addTop},e.duration,"easeOutStrong").run()))},cleanRecords:function(){var a=this;a.ATTR("dragInfoX",[]),a.ATTR("dragInfoY",[]),a.ATTR("dragInfoTime",[]),a.ATTR("autoSlideAnim")&&a.ATTR("autoSlideAnim").isRunning&&a.ATTR("autoSlideAnim").stop(!1)},closePopup:function(a){if(void 0!=a&&a instanceof KISSY.EventObject){var b=a.keyCode||a.charCode;if(a.altKey||27!=b)return!1}var c=this;c.config,c.ATTR("activeImg",null),c.cancelWheelEvent(),c.cancelEvent(),l.hide(c.ATTR("popupMask")),l.hide(c.ATTR("popupBd")),l.hide(c.ATTR("closeBtn")),l.hide(c.ATTR("ieIframeMask"))},destory:function(){}},s=n.DEGRADATION,t=n.WHEEL_STEP,u="";return a.augment(e,b,a.EventTarget,r),e},{requires:["./asdbase","template","anim","./assets/image-dd.css"]});